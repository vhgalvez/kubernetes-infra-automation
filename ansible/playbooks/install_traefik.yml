---
- name: Instalar y Configurar Traefik como Ingress Controller en Docker
  hosts: load_balancers
  become: true
  vars:
    traefik_image: "traefik:v3.3"
    traefik_container_name: "traefik"
    traefik_config_dir: "/etc/traefik"
    traefik_domain: "{{ traefik_domain }}"
    letsencrypt_email: "{{ letsencrypt_email }}"
    docker_compose_file: "{{ traefik_config_dir }}/docker-compose.yml"
    kubeconfig_tmp_local: "/tmp/kubeconfig_from_master1.yaml"

  pre_tasks:
    - name: Obtener kubeconfig del nodo master en el controlador (solo se ejecuta en localhost)
      delegate_to: localhost
      run_once: true
      become: false
      ansible.builtin.shell: |
        ssh -o StrictHostKeyChecking=no -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift core@10.17.4.21 'sudo cat /etc/rancher/k3s/k3s.yaml' > {{ kubeconfig_tmp_local }}
      args:
        executable: /bin/bash

    - name: Modificar el endpoint del servidor API para que apunte al VIP
      delegate_to: localhost
      become: false
      run_once: true
      ansible.builtin.replace:
        path: "{{ kubeconfig_tmp_local }}"
        regexp: 'server: https://127.0.0.1:6443'
        replace: 'server: https://10.17.5.10:6443'

  tasks:
    - name: Verificar si Docker está instalado
      ansible.builtin.command: "docker -v"
      register: docker_installed
      ignore_errors: yes
      changed_when: false

    - name: Instalar Docker si no está instalado
      ansible.builtin.shell: |
        dnf install -y docker docker-compose && systemctl enable --now docker
      when: docker_installed.rc != 0

    - name: Crear directorio de configuración de Traefik
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}"
        state: directory
        mode: "0755"

    - name: Copiar kubeconfig desde localhost al nodo
      ansible.builtin.shell: |
        scp -i /root/.ssh/cluster_openshift/key_cluster_openshift/id_rsa_key_cluster_openshift -o StrictHostKeyChecking=no {{ kubeconfig_tmp_local }} core@{{ inventory_hostname }}:{{ traefik_config_dir }}/kubeconfig
      delegate_to: localhost
      run_once: false

    - name: Crear archivo acme.json
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}/acme.json"
        state: touch
        mode: "0600"

    - name: Crear archivo traefik.toml
      ansible.builtin.template:
        src: "../../templates/traefik/traefik.toml.j2"
        dest: "{{ traefik_config_dir }}/traefik.toml"
        mode: "0644"

    - name: Crear archivo docker-compose.yml
      ansible.builtin.template:
        src: "../../templates/traefik/docker-compose.yml.j2"
        dest: "{{ docker_compose_file }}"
        mode: "0644"

    - name: Detener cualquier contenedor Traefik anterior
      ansible.builtin.shell: docker-compose down || true
      args:
        chdir: "{{ traefik_config_dir }}"
      ignore_errors: yes

    - name: Iniciar Traefik
      ansible.builtin.shell: docker-compose up -d
      args:
        chdir: "{{ traefik_config_dir }}"

    - name: Verificar estado de Traefik
      ansible.builtin.command: docker ps -f name={{ traefik_container_name }}
      register: traefik_status
      changed_when: false

    - name: Mostrar resultado
      ansible.builtin.debug:
        msg: "{{ traefik_status.stdout_lines }}"